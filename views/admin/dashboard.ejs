<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="admin-page">
    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo-icon">âš™ï¸</span>
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#overview" class="nav-link active" onclick="showSection('overview')">
                    <span>ğŸ“Š</span> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
                </a>
                <a href="#security" class="nav-link" onclick="showSection('security')">
                    <span>ğŸ”’</span> Ø§Ù„Ø£Ù…Ø§Ù†
                </a>
                <a href="#sessions" class="nav-link" onclick="showSection('sessions')">
                    <span>ğŸ‘¥</span> Ø§Ù„Ø¬Ù„Ø³Ø§Øª
                </a>
                <a href="#settings" class="nav-link" onclick="showSection('settings')">
                    <span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </a>
                <a href="/" class="nav-link">
                    <span>ğŸ </span> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="content-header">
                <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <div class="header-actions">
                    <span class="status-badge online">â— Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„</span>
                    <button onclick="refreshStats()" class="refresh-btn">
                        <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </header>

            <!-- Overview Section -->
            <section id="overview" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon uptime">â±ï¸</div>
                        <div class="stat-info">
                            <h3>ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
                            <p class="stat-value" id="uptime"><%= Math.floor(stats.uptime / 3600) %> Ø³Ø§Ø¹Ø©</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon memory">ğŸ’¾</div>
                        <div class="stat-info">
                            <h3>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
                            <p class="stat-value" id="memory"><%= Math.round(stats.memory.heapUsed / 1024 / 1024) %> MB</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon sessions">ğŸ‘¥</div>
                        <div class="stat-info">
                            <h3>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                            <p class="stat-value" id="sessions-count"><%= stats.cookies.sessions %></p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon cookies">ğŸª</div>
                        <div class="stat-info">
                            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¹Ø±ÙŠÙ</h3>
                            <p class="stat-value" id="cookies-count"><%= stats.cookies.totalCookies %></p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon blocked">ğŸš«</div>
                        <div class="stat-info">
                            <h3>Ø¹Ù†Ø§ÙˆÙŠÙ† IP Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
                            <p class="stat-value" id="blocked-ips"><%= stats.security.blockedIPs %></p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon domains">ğŸŒ</div>
                        <div class="stat-info">
                            <h3>Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
                            <p class="stat-value" id="blocked-domains"><%= stats.security.blockedDomains %></p>
                        </div>
                    </div>
                </div>

                <div class="features-status">
                    <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ²Ø§Øª</h3>
                    <div class="features-grid">
                        <div class="feature-item <%= stats.features.websockets ? 'enabled' : 'disabled' %>">
                            <span class="feature-status"><%= stats.features.websockets ? 'âœ…' : 'âŒ' %></span>
                            <span>WebSockets</span>
                        </div>
                        <div class="feature-item <%= stats.features.mediaStreaming ? 'enabled' : 'disabled' %>">
                            <span class="feature-status"><%= stats.features.mediaStreaming ? 'âœ…' : 'âŒ' %></span>
                            <span>Ø¨Ø« Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</span>
                        </div>
                        <div class="feature-item <%= stats.features.javascriptRewrite ? 'enabled' : 'disabled' %>">
                            <span class="feature-status"><%= stats.features.javascriptRewrite ? 'âœ…' : 'âŒ' %></span>
                            <span>Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© JS</span>
                        </div>
                        <div class="feature-item <%= stats.features.cookieSync ? 'enabled' : 'disabled' %>">
                            <span class="feature-status"><%= stats.features.cookieSync ? 'âœ…' : 'âŒ' %></span>
                            <span>Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¹Ø±ÙŠÙ</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Security Section -->
            <section id="security" class="section">
                <div class="section-grid">
                    <div class="panel">
                        <h3>Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
                        <div class="ip-management">
                            <form onsubmit="return blockIP(event)">
                                <div class="form-group">
                                    <input type="text" id="block-ip-input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† IP" required>
                                    <input type="text" id="block-reason-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                    <button type="submit" class="btn btn-danger">Ø­Ø¸Ø±</button>
                                </div>
                            </form>
                            
                            <div class="list-container">
                                <h4>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                                <ul id="blocked-ips-list" class="item-list">
                                    <% blockedIPs.forEach(function(ip) { %>
                                        <li>
                                            <span><%= ip %></span>
                                            <button onclick="unblockIP('<%= ip %>')" class="btn btn-small">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
                                        </li>
                                    <% }); %>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
                        <div class="domain-management">
                            <form onsubmit="return blockDomain(event)">
                                <div class="form-group">
                                    <input type="text" id="block-domain-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ (Ù…Ø«Ø§Ù„: example.com)" required>
                                    <button type="submit" class="btn btn-danger">Ø­Ø¸Ø±</button>
                                </div>
                            </form>
                            
                            <div class="list-container">
                                <h4>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                                <ul id="blocked-domains-list" class="item-list">
                                    <% blockedDomains.forEach(function(domain) { %>
                                        <li>
                                            <span><%= domain %></span>
                                            <button onclick="unblockDomain('<%= domain %>')" class="btn btn-small">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
                                        </li>
                                    <% }); %>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sessions Section -->
            <section id="sessions" class="section">
                <div class="panel">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h3>
                    <div class="sessions-info">
                        <div class="info-row">
                            <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:</span>
                            <strong id="active-sessions"><%= stats.cookies.sessions %></strong>
                        </div>
                        <div class="info-row">
                            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¹Ø±ÙŠÙ:</span>
                            <strong id="total-cookies"><%= stats.cookies.totalCookies %></strong>
                        </div>
                    </div>
                    <button onclick="clearAllSessions()" class="btn btn-danger">
                        <span>ğŸ—‘ï¸</span> Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
                    </button>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="section">
                <div class="section-grid">
                    <div class="panel">
                        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Øª</h3>
                        <div class="settings-list">
                            <div class="setting-item">
                                <label>WebSockets</label>
                                <button onclick="toggleFeature('websockets')" class="toggle-btn <%= stats.features.websockets ? 'on' : 'off' %>">
                                    <%= stats.features.websockets ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„' %>
                                </button>
                            </div>
                            <div class="setting-item">
                                <label>Ø¨Ø« Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</label>
                                <button onclick="toggleFeature('mediaStreaming')" class="toggle-btn <%= stats.features.mediaStreaming ? 'on' : 'off' %>">
                                    <%= stats.features.mediaStreaming ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„' %>
                                </button>
                            </div>
                            <div class="setting-item">
                                <label>Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© JavaScript</label>
                                <button onclick="toggleFeature('javascriptRewrite')" class="toggle-btn <%= stats.features.javascriptRewrite ? 'on' : 'off' %>">
                                    <%= stats.features.javascriptRewrite ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„' %>
                                </button>
                            </div>
                            <div class="setting-item">
                                <label>Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¹Ø±ÙŠÙ</label>
                                <button onclick="toggleFeature('cookieSync')" class="toggle-btn <%= stats.features.cookieSync ? 'on' : 'off' %>">
                                    <%= stats.features.cookieSync ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„' %>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                        <div class="system-info">
                            <div class="info-row">
                                <span>Ø¥ØµØ¯Ø§Ø± Node.js:</span>
                                <strong><%= stats.nodeVersion %></strong>
                            </div>
                            <div class="info-row">
                                <span>Ù†Ø·Ø§Ù‚Ø§Øª IP Ø§Ù„Ø®Ø§ØµØ© Ø§Ù„Ù…Ø­Ù…ÙŠØ©:</span>
                                <strong><%= stats.security.privateRanges %></strong>
                            </div>
                            <div class="info-row">
                                <span>Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©:</span>
                                <strong><%= stats.security.metadataEndpoints %></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Section navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Refresh stats
        async function refreshStats() {
            try {
                const response = await fetch('/admin/api/stats');
                const data = await response.json();
                
                document.getElementById('uptime').textContent = Math.floor(data.uptime / 3600) + ' Ø³Ø§Ø¹Ø©';
                document.getElementById('memory').textContent = Math.round(data.memory.heapUsed / 1024 / 1024) + ' MB';
                document.getElementById('sessions-count').textContent = data.connections.sessions;
                document.getElementById('cookies-count').textContent = data.connections.cookies;
                document.getElementById('blocked-ips').textContent = data.security.blockedIPs;
                document.getElementById('blocked-domains').textContent = data.security.blockedDomains;
                
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
            }
        }

        // Block IP
        async function blockIP(event) {
            event.preventDefault();
            const ip = document.getElementById('block-ip-input').value;
            const reason = document.getElementById('block-reason-input').value;
            
            try {
                const response = await fetch('/admin/api/block-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, reason })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                } else {
                    alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
            return false;
        }

        // Unblock IP
        async function unblockIP(ip) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± ' + ip + 'ØŸ')) return;
            
            try {
                const response = await fetch('/admin/api/unblock-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // Block domain
        async function blockDomain(event) {
            event.preventDefault();
            const domain = document.getElementById('block-domain-input').value;
            
            try {
                const response = await fetch('/admin/api/block-domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
            return false;
        }

        // Unblock domain
        async function unblockDomain(domain) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± ' + domain + 'ØŸ')) return;
            
            try {
                const response = await fetch('/admin/api/unblock-domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // Toggle feature
        async function toggleFeature(feature) {
            const btn = event.target;
            const currentState = btn.classList.contains('on');
            
            try {
                const response = await fetch('/admin/api/toggle-feature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feature, enabled: !currentState })
                });
                
                const data = await response.json();
                if (data.success) {
                    location.reload();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // Clear all sessions
        async function clearAllSessions() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§ØªØŸ')) return;
            
            try {
                const response = await fetch('/admin/api/clear-sessions', {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª');
                    location.reload();
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // Auto refresh every 30 seconds
        setInterval(refreshStats, 30000);
    </script>
</body>
</html>
